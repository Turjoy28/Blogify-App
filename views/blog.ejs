<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= blog.title %> - Blog</title>
    <%- include('./partials/head') %>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; background:whitesmoke}
        .container { max-width: 800px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .author { display: flex; align-items: center; margin-bottom: 20px; }
        .author img { width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-secondary { background: #6c757d; color: white; }
        .comment, .reply { border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin-bottom: 10px; background: #f8f9fa; }
        .reply { margin-left: 30px; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
        form { margin-bottom: 15px; }
        h1, h3 { margin-bottom: 15px; }
        .d-flex { display: flex; align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .me-2 { margin-right: 10px; }
        .ms-2 { margin-left: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .mt-2 { margin-top: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .rounded-circle { border-radius: 50%; }
        .date { font-size: 0.85em; color: #666; }
    </style>
</head>

<body>
    <%- include('./partials/nav') %>

    <div class="container">
        <!-- Blog Title -->
        <div class="text-center mb-4">
            <h1 class="mb-3" style="font-size: 2.5rem;"><%= blog.title %></h1>
            <% if(blog.coverImgURL) { %>
                <img src="<%= blog.coverImgURL %>" alt="Cover Image" style="
                    max-width: 65%;
                    height: auto;
                    border-radius: 8px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                ">
            <% } %>
        </div>

        <!-- Blog Body -->
        <p><%= blog.body %></p>

        <!-- Blog Author Info + Date -->
        <div class="author d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <img src="<%= blog.createdBy.profileImgURL %>" alt="Author">
                <strong class="ms-2"><%= blog.createdBy.fullName %></strong>
            </div>
            <span class="date">
                <%= blog.createdAt.toLocaleString('en-US', { 
                    weekday:'long', year:'numeric', month:'long', day:'numeric', 
                    hour:'2-digit', minute:'2-digit', second:'2-digit' }) %>
            </span>
        </div>

        <!-- Blog Actions (Edit/Delete) -->
        <% if(user && blog.createdBy._id.toString() === user._id.toString()) { %>
            <form action="/blog/<%= blog._id %>/update" method="POST" enctype="multipart/form-data" class="mb-2">
                <input type="text" name="title" value="<%= blog.title %>" placeholder="Edit title" required>
                <textarea name="body" placeholder="Edit content" required><%= blog.body %></textarea>
                <input type="file" name="coverImage">
                <button class="btn btn-warning">Update Blog</button>
            </form>
            <form action="/blog/<%= blog._id %>/delete" method="POST">
                <button class="btn btn-danger">Delete Blog</button>
            </form>
        <% } %>

        <!-- Comments Section -->
        <h3>Comments (<%= comments.length %>)</h3>

        <!-- Add Comment Form -->
        <% if(user) { %>
            <form action="/blog/comment/<%= blog._id %>" method="POST">
                <input type="text" name="content" placeholder="Add a comment..." required>
                <button class="btn btn-primary">Comment</button>
            </form>
        <% } else { %>
            <p><a href="/user/signin">Sign in</a> to comment.</p>
        <% } %>

        <!-- Display Comments -->
        <% comments.forEach(comment => { %>
            <div class="comment">
                <div class="d-flex justify-content-between mb-2 align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="<%= comment.createdBy.profileImgURL %>" alt="User" width="35" height="35" class="rounded-circle me-2">
                        <strong><%= comment.createdBy.fullName %></strong>
                    </div>
                    <span class="date">
                        <%= comment.createdAt.toLocaleString('en-US', {
                            weekday:'short', year:'numeric', month:'short', day:'numeric',
                            hour:'2-digit', minute:'2-digit', second:'2-digit' }) %>
                    </span>
                </div>
                <p><%= comment.content %></p>

                <!-- Comment Actions -->
                <% if(user && comment.createdBy._id.toString() === user._id.toString()) { %>
                    <form action="/blog/comment/<%= comment._id %>/delete" method="POST" class="mb-2">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                <% } %>

                <!-- Replies -->
                <% comment.replies.forEach(reply => { %>
                    <div class="reply">
                        <div class="d-flex justify-content-between mb-1 align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="<%= reply.createdBy.profileImgURL %>" alt="User" width="30" height="30" class="rounded-circle me-2">
                                <strong><%= reply.createdBy.fullName %></strong>
                            </div>
                            <span class="date">
                                <%= reply.createdAt.toLocaleString('en-US', {
                                    weekday:'short', year:'numeric', month:'short', day:'numeric',
                                    hour:'2-digit', minute:'2-digit', second:'2-digit' }) %>
                            </span>
                        </div>
                        <p><%= reply.content %></p>

                        <% if(user && reply.createdBy._id.toString() === user._id.toString()) { %>
                            <form action="/blog/comment/<%= comment._id %>/reply/<%= reply._id %>/delete" method="POST">
                                <button class="btn btn-danger btn-sm">Delete Reply</button>
                            </form>
                        <% } %>
                    </div>
                <% }) %>

                <!-- Reply Form -->
                <% if(user) { %>
                    <form action="/blog/comment/<%= comment._id %>/reply" method="POST">
                        <input type="text" name="content" placeholder="Reply..." required>
                        <button class="btn btn-secondary btn-sm">Reply</button>
                    </form>
                <% } %>
            </div>
        <% }) %>

    </div>

    <%- include('./partials/script') %>
</body>
</html>
